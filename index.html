<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coconut's Valentine Run ‚ù§Ô∏è</title>
  <style>

    #envelopeOverlay {
    position: fixed; inset: 0; background: #0f0f14;
    display: flex; justify-content: center; align-items: center; z-index: 200;
}
.envelope-wrapper { 
    position: relative; width: 300px; height: 200px; 
    background: #6a1b9a; /* Deep Purple */
    border-radius: 0 0 10px 10px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.6);
}
.flap {
    position: absolute; top: 0; width: 0; height: 0;
    border-left: 150px solid transparent; border-right: 150px solid transparent;
    border-top: 110px solid #7b1fa2; /* Slightly lighter purple */
    transform-origin: top; transition: transform 0.6s ease; z-index: 4;
}
.pocket {
    position: absolute; top: 0; width: 300px; height: 200px;
    background: linear-gradient(135deg, #6a1b9a, #ff7043); /* Match game colors */
    border-radius: 0 0 10px 10px; z-index: 2;
}
.front {
    position: absolute; top: 0; width: 300px; height: 200px;
    z-index: 3; /* Sits above the letter, below the flap */
    background: linear-gradient(to top, rgba(106, 27, 154, 1), rgba(106, 27, 154, 0));
    border-radius: 0 0 10px 10px;
}
.address {
    position: absolute; bottom: 20px; right: 25px;
    font-family: 'Cursive', serif; font-style: italic;
    color: #ffd1ff; font-size: 18px; z-index: 5; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}
.letter {
    position: absolute; bottom: 5px; left: 10px; width: 280px; height: 170px;
    background: #fff; border-radius: 5px; padding: 15px; text-align: center;
    transition: transform 0.6s ease; z-index: 1; color: #333; box-sizing: border-box;
}
.heart-btn {
    position: absolute; top: 85px; left: 125px; width: 50px; height: 50px;
    background: #ff4f86; border: none; border-radius: 50%; color: white;
    font-size: 24px; cursor: pointer; z-index: 6; transition: 0.3s;
    box-shadow: 0 0 20px rgba(255, 79, 134, 0.6);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); box-shadow: 0 0 30px rgba(255, 79, 134, 0.8); }
    100% { transform: scale(1); }
}

/* Open State Animation */
.envelope-wrapper.open .flap { transform: rotateX(180deg); z-index: 0; }
.envelope-wrapper.open .letter { transform: translateY(-130px); z-index: 5; }
.envelope-wrapper.open .heart-btn { opacity: 0; pointer-events: none; }

    #quizOptions {
    display: none;
    flex-direction: column; /* Stack buttons on top of each other */
    gap: 12px;
    margin-top: 20px;
}

#quizProgressBar {
    box-shadow: 0 0 10px #ff4f86, 0 0 20px #ff4f86;
}

#quizOptions .btn {
    width: 100%; /* Make them full width */
    padding: 15px;
}
    html, body { 
    margin: 0; 
    height: 100%; 
    background: #0f0f14; 
    overflow: hidden; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
    
    /* Add this line here */
    -webkit-tap-highlight-color: transparent; 
}
    #wrap { height: 100%; display: grid; place-items: center; }
    canvas { 
    /* Your original styles */
    background: linear-gradient(#6a1b9a, #ff7043); 
    border-radius: 18px; 
    box-shadow: 0 20px 80px rgba(0,0,0,.4); 
    max-width: 100vw; 
    max-height: 100vh;
    
    /* The new mobile scaling additions */
    display: block;
    object-fit: contain; 
}
   .voucher {
    margin-top: 20px;
    background: linear-gradient(135deg, #fff3b0, #ffc107);
    border-radius: 15px;
    padding: 25px;
    color: #5d4037;
    text-align: center;
    border: 4px dashed #ffffff;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    position: relative;
    overflow: hidden;
}

/* The 3D Spinning Coin */
.coin-container {
    perspective: 1000px;
    width: 80px;
    height: 80px;
    margin: 0 auto 15px;
}

.coin-face {
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, #ffe082 20%, #ffb300 100%);
    border-radius: 50%;
    border: 5px double #ff8f00;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    font-weight: bold;
    color: #ff8f00;
    text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.3);
    animation: spinCoin 3s infinite linear;
}

@keyframes spinCoin {
    0% { transform: rotateY(0deg); }
    100% { transform: rotateY(360deg); }
}

.voucher h2 { margin: 0; font-size: 20px; letter-spacing: 1px; color: #8e6a00; }
.voucher .amount { font-size: 48px; font-weight: 900; margin: 5px 0; color: #3e2723; }
    .hud { position: fixed; left: 16px; top: 16px; color: #fff; font-size: 14px; padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,.06); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,.08); z-index: 10; }
    .hud b { color: #ff7aa2; }
    .modal { position: fixed; inset: 0; display: flex; place-items: center; justify-content: center; padding: 24px; background: rgba(15, 15, 20, 0.9); z-index: 100; }
    .card { width: min(520px, 92vw); background: rgba(40, 30, 50, 0.95); border: 2px solid #ff4f86; border-radius: 24px; padding: 32px; color: #fff; backdrop-filter: blur(12px); box-shadow: 0 0 40px rgba(255, 79, 134, 0.3); text-align: center; }
    .card h1 { margin: 0 0 15px; font-size: 32px; color: #ff7aa2; }
    .card p { margin: 0 0 20px; font-size: 18px; line-height: 1.5; opacity: 0.9; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; text-align: left; }
    .info-item { background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 12px; font-size: 14px; }
    .info-item b { display: block; color: #ff7aa2; margin-bottom: 4px; }
    .btn { 
    display: inline-block; 
    cursor: pointer; 
    user-select: none; 
    padding: 14px 20px; /* Slightly tighter padding for quiz buttons */
    border-radius: 15px; 
    background: #ff4f86; 
    color: #fff; 
    font-weight: 700; 
    font-size: 16px; /* Reduced from 18px for better fit */
    border: none; 
    transition: all 0.2s; 
}
    .btn:hover { background: #ff6b9a; transform: translateY(-2px); }
    /* Scrollable letter area for the final win screen */
.letter-content {
    max-height: 250px;
    overflow-y: auto;
    text-align: left;
    padding: 15px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 20px;
}
/* Style the scrollbar to match the theme */
.letter-content::-webkit-scrollbar { width: 6px; }
.letter-content::-webkit-scrollbar-thumb { background: #ff4f86; border-radius: 10px; }
  </style>
</head>
<body>
<div id="envelopeOverlay">
    <div class="envelope-wrapper" id="envelope">
        <div class="flap"></div>
        <div class="pocket"></div>
        <div class="letter">
            <p id="envelopeMessage">Happy V-Day!<br>Do you want to play a game?</p>
            <button class="btn" id="yesBtn" style="display:none;">Yes!</button>
        </div>
        <div class="front"></div> <div class="address">To Bri</div>
        <button class="heart-btn" id="openBtn">‚ù§Ô∏è</button>
    </div>
</div>
  <div class="hud">
  Distance: <b id="dist">0</b> / <b id="goal">2300</b>
</div>
  <div class="modal" id="modal">
    <div class="card">
        <div id="quizProgressContainer" style="display: none; width: 100%; background: rgba(255,255,255,0.1); height: 10px; border-radius: 5px; margin-bottom: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
  <div id="quizProgressBar" style="width: 0%; height: 100%; background: #ff4f86; transition: width 0.3s ease;"></div>
</div>
      <h1 id="modalTitle">Coconut's Valentine Run ‚ù§Ô∏è</h1>
      <p id="modalText"></p>
      <div id="infoSection" class="info-grid">
        <div class="info-item"><b>How to Play</b> Space / ‚Üë / Tap to jump. Jump over the pink blocks.</div>
        <div class="info-item"><b>Checkpoints</b> Trees turn pink and you unlock a message!</div>
        <div class="info-item"><b>The Goal</b> Reach 2300 miles. It's the distance from Carson to Chantilly!</div>
        <div class="info-item"><b>Prize</b> A gift from Kyel </div>
      </div>
      <div id="quizOptions" style="display: none; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
  <button class="btn" id="optA"></button>
  <button class="btn" id="optB"></button>
</div>

<button class="btn" id="modalBtn">Start!</button>
    </div>
  </div>

  <div id="wrap"><canvas id="c" width="960" height="540"></canvas></div>

<script>
(() => {
    const password = prompt("Enter the secret code to play. HINT: Rhyme a word. A witch hitched a ride to the ditch to snitch on stitch.");
if (password !== "bitch") { // Change this to your password
    alert("Incorrect code! Access denied.");
    document.body.innerHTML = "<h1>404 Not Found</h1>"; // Makes it look like a broken link
    return;
}

document.getElementById("openBtn").onclick = () => {
    document.getElementById("envelope").classList.add("open");
    // Show the button after the letter slides up
    setTimeout(() => {
        document.getElementById("yesBtn").style.display = "inline-block";
    }, 800);
};

document.getElementById("yesBtn").onclick = function() {
    const msg = document.getElementById("envelopeMessage");
    
    if (this.textContent === "Yes!") {
        msg.innerHTML = "First, you must pass my test kekeke... ‚ù§Ô∏è";
        this.textContent = "Okay!";
    } else {
        // Final fade out
        const overlay = document.getElementById("envelopeOverlay");
        overlay.style.transition = "opacity 1s ease";
        overlay.style.opacity = "0";
        setTimeout(() => {
            overlay.style.display = "none";
            showQuestion(); // Start your quiz logic
        }, 1000);
    }
};
// 1. QUIZ DATA
// 1. THE BIG QUIZ DATA
const questions = [
  { q: "Where was our very first date?", a: "A Very Nice Tunnel", b: "A Museum", correct: "a" },
  { q: "What's our go-to post food dessert?", a: "Ice-Cream", b: "Pastries", correct: "a" },
  { q: "Which month did we first meet?", a: "October", b: "November", correct: "b" },
  { q: "What word do I use to describe you the most?", a: "Beautiful", b: "Autistic", correct: "a" },
  { q: "Who said 'I love you' first?", a: "Kyel", b: "Bri", correct: "a" },
  { q: "How long is my cucumber?", a: "6 inches", b: "7 million inches", correct: "b" },
  { q: "How much cheese board can a Brit Knee eat?", a: "HAI", b: "1 Serving Size", correct: "a" },
  { q: "How many miles is Carson to Chantilly in a straight line?", a: "2,300", b: "1,800", correct: "a" },
  { q: "What's our most played position?", a: "69", b: "Amen", correct: "b" },
  { q: "Ready to play a game for your Valentine's prize?", a: "No bitch", b: "YES!", correct: "b" }
];

let currentQ = 0;
let quizCompleted = false;

function showQuestion() {
  if (quizCompleted) return;

  const q = questions[currentQ];
  
  // 1. Show the progress container
  document.getElementById("quizProgressContainer").style.display = "block";
  
  // 2. Calculate percentage (e.g., 1/10 = 10%)
  const percent = ((currentQ) / questions.length) * 100;
  document.getElementById("quizProgressBar").style.width = percent + "%";

  // 3. Update Text
  document.getElementById("modalTitle").textContent = `Question ${currentQ + 1} of ${questions.length}`;
  document.getElementById("modalText").textContent = q.q;
  
  // 4. Update UI visibility
  document.getElementById("infoSection").style.display = "none";
  document.getElementById("modalBtn").style.display = "none";
  document.getElementById("quizOptions").style.display = "grid";
  
  document.getElementById("optA").textContent = q.a;
  document.getElementById("optB").textContent = q.b;
}

function handleAnswer(choice) {
  if (choice === questions[currentQ].correct) {
    currentQ++;
    if (currentQ < questions.length) {
      showQuestion();
    } else {
      // QUIZ FINISHED!
      quizCompleted = true;
      // Inside handleAnswer where it says "QUIZ FINISHED!"
quizCompleted = true;
document.getElementById("quizProgressContainer").style.display = "none"; // <--- Add this
      document.getElementById("quizOptions").style.display = "none";
      document.getElementById("modalBtn").style.display = "inline-block";
      document.getElementById("infoSection").style.display = "grid";
      document.getElementById("modalTitle").textContent = "Coconut's Valentine Run ‚ù§Ô∏è";
      document.getElementById("modalText").textContent = "Great job, baby! Now, reach the finish line to get your gift.";
    }
  } else {
    alert("Incorrect! Who are you? My gf remembers the details... starting over! ‚ù§Ô∏è");
    currentQ = 0;
    showQuestion();
  }
}

// LINK THE QUIZ BUTTONS TO THE LOGIC
document.getElementById("optA").onclick = () => handleAnswer("a");
document.getElementById("optB").onclick = () => handleAnswer("b");

// 3. START THE QUIZ
showQuestion();


  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  const groundY = H - 80;
  const finishX = 18000;
  const baseSpeed = 7;

  let player, cam, hearts, fireworks, obstacles, checkpointState, paused = true, gameStarted = false;


let finalFade = 0; 
  let isTerminated = false;
  

  const CHECKPOINTS = [
    { 
  x: 1600,  
  title: "Checkpoint 1 üíó", 
  text: `Starting strong! Happy Valentine's Day my love! I love you so very much, and I'm really proud of you for being so good :) Keep on rolling Coconut~ 
  <br><img src="https://raw.githubusercontent.com/kk1113/tomabok-project-ig-random-bee/main/Meme.jpg" style="width:50%; border-radius:5px; margin-top:5px;">`
},
    { 
        x: 3200,  
        title: "Checkpoint 2 üíû", 
    text: `They see me roll'in, they hat'in~ Baby I know I tell you everyday, but you're the most beautiful girl in the expanding universe!
    <br><img src="https://raw.githubusercontent.com/kk1113/tomabok-project-ig-random-bee/main/image2.jpg" style="width:50%; border-radius:5px; margin-top:5px;">`

},

    { 
        x: 4800,  
        title: "Checkpoint 3 üå∏", 
    text: `My baby girl you are the best gamer! You know you make me daydream about the dirtiest things, love. Sorry I'm not able to clap your cheeks tonight like you deserve sweetie pie...
<br><img src="https://raw.githubusercontent.com/kk1113/tomabok-project-ig-random-bee/main/image3.jpg" style="width:50%; border-radius:5px; margin-top:5px;">`
},

    { 
        x: 6400,  
        title: "Checkpoint 4 üíò", 
    text: `Almost halfway there! Hey shawty ;) Someone once said that love doesn't just sit there, like a stone, it has to be made, like bread; remade all the time, made new. I like the bread we're baking~ Your buns are nice too :)
    <br><img src="https://raw.githubusercontent.com/kk1113/tomabok-project-ig-random-bee/main/image4.jpg" style="width:50%; border-radius:5px; margin-top:5px;">`
    },

    { 
        x: 8000,  
        title: "Checkpoint 5 üéÄ", 
    text: `Halfway! You're too good at this. I hope all these messages are distracting you enough. How many times have you read this message? üòõ
    <br><img src="https://raw.githubusercontent.com/kk1113/tomabok-project-ig-random-bee/main/image5.jpg" style="width:50%; border-radius:5px; margin-top:5px;">`
    },

    { 
        x: 9600,  
        title: "Checkpoint 6 üíù", 
    text: `The pace is picking up! Baby I don't tell you enough that you're amazing inside and out. I think we fit really well too, both inside and out ;)
    <br><img src="https://raw.githubusercontent.com/kk1113/tomabok-project-ig-random-bee/main/image6.jpg" style="width:50%; border-radius:5px; margin-top:5px;">`
    },

    { 
        x: 11200, 
        title: "Checkpoint 7 üåü", 
    text: `1400m! You're locked in wowowowow. Funny, smart, kind, and beautiful. I read that someone said that about you recentlty. It was me.
    <br><img src="https://raw.githubusercontent.com/kk1113/tomabok-project-ig-random-bee/main/image7.jpg" style="width:50%; border-radius:5px; margin-top:5px;">`
},

    { 
        x: 12800, 
        title: "Checkpoint 8 ‚ú®", 
    text: `Final stretch! Ready for the triples? There's a triple jump coming, honey. I'm warning you because I love you and because you are such a good girl. 
    <br><img src="https://raw.githubusercontent.com/kk1113/tomabok-project-ig-random-bee/main/image 8.jpg" style="width:50%; border-radius:5px; margin-top:5px;">`
},

    { 
        x: 16500, 
        title: "Checkpoint 9 ‚ù§Ô∏è", 
    text: `The finish line is in sight! You did amazing my love. I hope you had fun! 
<br><img src="https://raw.githubusercontent.com/kk1113/tomabok-project-ig-random-bee/main/image9.jpg" style="width:50%; border-radius:5px; margin-top:5px;">`
},
  ];

  function spawnHeart(x, y) {
    fireworks.push({
      // Offset x and y so particles emerge from the lower-back area
      x: x - 10, 
      y: y + 5,
      vx: (Math.random() * 1.5 - 1), // Slightly more horizontal spread
      vy: -0.5 - Math.random() * 1,  // Slower upward drift
      life: 50,
      size: 7 + Math.random() * 6    // Reduced size (was 8-18, now 4-10)
    });
  }
function drawHeartArch(x) {
  const screenX = x - cam.x;
  const archRadius = 135;

  ctx.save();
  // A soft pink glow behind the whole cluster
  ctx.shadowBlur = 35;
  ctx.shadowColor = "rgba(255, 79, 134, 0.6)";

  // Loop to create a dense cluster
  // We use 20 steps to make sure there are no gaps
  for (let i = 0; i <= 20; i++) {
    let angle = Math.PI + (i * Math.PI / 20);
    
    // We draw 3 hearts at each angle with different offsets to create "thickness"
    for (let j = 0; j < 3; j++) {
      let offset = (j * 15) - 15; // Creates hearts at -15, 0, and +15 pixels from the center
      let hX = screenX + Math.cos(angle) * (archRadius + offset);
      let hY = groundY + Math.sin(angle) * (archRadius + offset);
      
      // Randomize the size slightly for a natural "clustered" look
      let size = 12 + (i % 3) * 4; 
      
      // Use your reddish-pink color
      ctx.fillStyle = "#ff4f86";
      drawHeart(hX, hY, size);
      
      // Add a tiny white highlight to some hearts for a "shimmer" effect
      if ((i + j) % 5 === 0) {
        ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
        drawHeart(hX - 2, hY - 2, size * 0.5);
      }
    }
  }

  // 2. THE "FINISH" SIGN
  ctx.shadowBlur = 0;
  ctx.fillStyle = "white";
  ctx.font = "bold 24px system-ui";
  ctx.textAlign = "center";
  // Outline for readability
  ctx.strokeStyle = "#ff4f86";
  ctx.lineWidth = 4;
  ctx.strokeText("FINISH", screenX, groundY - archRadius - 30);
  ctx.fillText("FINISH", screenX, groundY - archRadius - 30);
  
  ctx.restore();
}
 function init() {
    player = { x: 60, y: groundY - 44, r: 22, vx: baseSpeed, vy: 0, onGround: true, alive: true, rotation: 0 };
    cam = { x: 0 };
    hearts = [];
    fireworks = [];
    checkpointState = CHECKPOINTS.map(cp => ({ ...cp, hit: false }));
    
    obstacles = [];
    let nextX = 700;
    while (nextX < finishX - 500) {
      const progress = nextX / finishX; 
      const nearCP = CHECKPOINTS.some(cp => Math.abs(nextX - cp.x) < 300);
      
      if (!nearCP) {
        const roll = Math.random();
        
        // Final Stretch Triple Jumps (Progress > 80%)
        if (progress > 0.8 && roll < 0.35) {
          const tGap = 230; // WIDENED from 210 to 250 for easier landing
          obstacles.push({ x: nextX, y: groundY - 35, w: 35, h: 35 });
          obstacles.push({ x: nextX + tGap, y: groundY - 35, w: 35, h: 35 });
          obstacles.push({ x: nextX + (tGap * 2), y: groundY - 35, w: 35, h: 35 });
          nextX += (tGap * 2);
        } 
        // Mid-Game Double Jumps
        else if (progress > 0.2 && roll < 0.4) {
          obstacles.push({ x: nextX, y: groundY - 35, w: 35, h: 35 });
          obstacles.push({ x: nextX + 175, y: groundY - 35, w: 35, h: 35 }); // WIDENED from 180 to 220
          nextX += 220;
        } 
        // Single Obstacles
        else {
          const isTall = Math.random() < 0.3; 
          obstacles.push({ x: nextX, y: isTall ? groundY - 70 : groundY - 35, w: 35, h: isTall ? 70 : 35 });
        }
      }

      // THE GAP LOGIC: 
      // Changed the minimum gap from 200 to 350 so she has time to breathe!
      const gapBase = 450 - (progress * 250); 
      nextX += gapBase + (Math.random() * 150);
    }
  }

  function drawPalmTree(x, y, isHit) {
    ctx.save();
    if (isHit) {
        ctx.shadowBlur = 25;
        ctx.shadowColor = "#ff7aa2";
    }

    // Segmented Trunk (The "Bumpy" look)
    ctx.fillStyle = isHit ? "#5D3A1A" : "#8B4513";
    for (let i = 0; i < 11; i++) {
        let segmentY = y - (i * 8);
        let segmentX = x + Math.sin(i * 0.2) * 6; 
        ctx.beginPath();
        ctx.ellipse(segmentX, segmentY, 8 - (i * 0.4), 6, 0, 0, Math.PI * 2);
        ctx.fill();
    }

    // Thick Leaf Canopy
    const leafColor = isHit ? "#ff7aa2" : "#2E8B57";
    const trunkTopX = x + Math.sin(10 * 0.2) * 6;
    const trunkTopY = y - 88;

    ctx.fillStyle = leafColor;
    for (let i = 0; i < 6; i++) {
        ctx.save();
        ctx.translate(trunkTopX, trunkTopY);
        ctx.rotate((i * 60 + 30) * Math.PI / 180); 
        ctx.beginPath();
        ctx.ellipse(20, 0, 25, 8, 0.1, 0, Math.PI * 2);
        ctx.fill();
        // Leaf Spine
        ctx.strokeStyle = "rgba(0,0,0,0.1)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0,0); ctx.lineTo(35, 0); ctx.stroke();
        ctx.restore();
    }
    ctx.restore();
  }

  function drawCoconutPlayer(px, py, r, rotation, alive) {
    ctx.save();
    ctx.translate(px + r, py + r);
    ctx.rotate(rotation);
    ctx.fillStyle = alive ? "#5d3a1a" : "#3d2a1a";
    ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.beginPath(); ctx.arc(-8, -2, 6, 0, 7); ctx.fill();
    ctx.beginPath(); ctx.arc(8, -2, 6, 0, 7); ctx.fill();
    ctx.fillStyle = "#000";
    ctx.beginPath(); ctx.arc(-8, -2, 3, 0, 7); ctx.fill();
    ctx.beginPath(); ctx.arc(8, -2, 3, 0, 7); ctx.fill();
    ctx.fillStyle = "#ff4f86";
    ctx.beginPath(); ctx.ellipse(-9, -r+2, 7, 5, 0.8, 0, 7); ctx.fill();
    ctx.beginPath(); ctx.ellipse(1, -r+2, 7, 5, -0.8, 0, 7); ctx.fill();
    ctx.restore();
  }
  
  function terminateGame() {
    isTerminated = true;
    paused = false; 
    document.getElementById("modal").style.display = "none";

    // FADE MUSIC:
    const music = document.getElementById("bgMusic");
    const fadeAudio = setInterval(() => {
        if (music.volume > 0.01) {
            music.volume -= 0.01;
        } else {
            music.pause();
            clearInterval(fadeAudio);
        }
    }, 100);
    
    for(let i = 0; i < 100; i++) {
        fireworks.push({
            x: player.x + (Math.random() * 400 - 200), 
            y: player.y + (Math.random() * 400 - 200),
            vx: (Math.random() * 10 - 5), 
            vy: -Math.random() * 15,
            life: 100, 
            size: 10 + Math.random() * 15
        });
    }
}

  function update() {
    if (isTerminated) return; // Stop normal game logic during the finale
    // ... the rest of your update code
    // Inside update()
    if (gameStarted && !paused && player.alive) {
      // Lowering to 0.15 makes the trail look more delicate
      if (Math.random() < 0.15) spawnHeart(player.x, player.y + player.r);
    }
    if (paused || !gameStarted || !player.alive) return;
    const speedBoost = Math.floor(player.x / 1000) * 0.11;
    player.vx = baseSpeed + speedBoost;
    player.vy += 1.2;
    player.y += player.vy;
    player.x += player.vx;
    if(player.onGround) player.rotation += 0.15;
    if (player.y + (player.r * 2) >= groundY) {
      player.y = groundY - (player.r * 2);
      player.vy = 0; player.onGround = true;
    }
    cam.x = player.x - 220;
    // This maps 0 -> 18,000 real distance to 0 -> 2,300 display distance
let displayDist = Math.floor((player.x / finishX) * 2300);
document.getElementById("dist").textContent = displayDist;
    
    // Heart Spawn
    if (Math.random() < 0.2) spawnHeart(player.x + player.r, player.y + player.r);

    // Particles Update
    for (let i = fireworks.length - 1; i >= 0; i--) {
      let h = fireworks[i];
      h.x += h.vx; h.y += h.vy; h.life--;
      if (h.life <= 0) fireworks.splice(i, 1);
    }

    checkpointState.forEach(cp => {
      if (!cp.hit && player.x >= cp.x) {
        cp.hit = true; 
        paused = true;
        document.getElementById("modalTitle").textContent = cp.title;
        document.getElementById("modalText").innerHTML = cp.text;
        
        // CHANGE BUTTON TEXT HERE
        document.getElementById("modalBtn").textContent = "Continue";
        
        document.getElementById("infoSection").style.display = "none";
        document.getElementById("modal").style.display = "flex";
      }
    });
    obstacles.forEach(ob => {
      const p = 8;
      if (player.x + (player.r*2) > ob.x+p && player.x < ob.x+ob.w-p && player.y + (player.r*2) > ob.y+p && player.y < ob.y+ob.h-p) {
        player.alive = false;
        document.getElementById("modalTitle").textContent = "Cracked! üòâü••";
        document.getElementById("modalText").textContent = "Try again! You can do it.";
        document.getElementById("modal").style.display = "flex";
      }
    });


    // 2. CHECK FOR THE FINISH LINE
    if (player.x >= finishX && !paused) {
      paused = true;
      
      // Fire the heart particles
      for(let i = 0; i < 60; i++) {
        fireworks.push({
          x: player.x, y: player.y,
          vx: (Math.random() * 8 - 4), vy: -5 - Math.random() * 10,
          life: 90, size: 5 + Math.random() * 10
        });
      }

      // 3. DEFINE THE LETTER CONTENT FIRST
      const longLetter = `
        Happy Valentine's Day!<br><br>
        Although I cannot be with you today, and I am so very sad that we can't celebrate this occasion together over a nice meal and later on a comfy bed, 
        I hope this game still brought a little bit of joy to you and made you feel special, my love. I thought of us the entire time I was building it, and I couldn't help but laugh at how many little things we have connected over the past year. 
        From petnames to insides jokes to memes and just our general everyday experiences, I found so many things from our time together that I could incorporate into this project for you.
        I know I'm not the best with words when it comes to the romantic stuff, but I hope my feelings were able to reach you through the screen a little.
        Looking back, it's definitely crazy and just a little delulu to think that we've endured this 2300 mile distance between us for a whole year. I've definitely grown as a person because of you, and I want to say how amazing it has been to be with you this past year.
        Despite it all, I've put my depressive and calculating side down for this day and made this to fullheartedly celebrate our journey together and admire how far we've come, because I really have enjoyed it overall. And I hope you have too.
        You're so special to me and I love you, baby. Thanks for being the amazing person that you are. Let's go conquer the world! <br><br>
       
        Your bf,<br><br>
        Kyle
        
        <div class="voucher">
    <div class="coin-container">
        <div class="coin-face">‚òÖ</div>
    </div>
    <h2>VALENTINE'S GIFT COIN</h2>
    <div class="amount">$50</div>
    <p>Because you've been so good with your personal finances and you deserve to shop!</p>
</div>
      `;

      // 4. NOW UPDATE THE MODAL (Since longLetter is now defined)
      document.getElementById("modalTitle").textContent = "My Dearest, ‚ù§Ô∏è";
      
      const textElement = document.getElementById("modalText");
      textElement.innerHTML = `<div class="letter-content">${longLetter}</div>`;
      
      document.getElementById("modalBtn").textContent = "The End ‚ù§Ô∏è";
      document.getElementById("infoSection").style.display = "none"; // Clears the icons to make space
      document.getElementById("modal").style.display = "flex";
    }
  }    

  function drawHeart(x, y, s) {
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.bezierCurveTo(x, y - s/2, x - s, y - s/2, x - s, y);
    ctx.bezierCurveTo(x - s, y + s/2, x, y + s, x, y + s);
    ctx.bezierCurveTo(x, y + s, x + s, y + s/2, x + s, y);
    ctx.bezierCurveTo(x + s, y - s/2, x, y - s/2, x, y);
    ctx.fill();
  }

  function draw() {
    // 1. SKY
    const skyGrad = ctx.createLinearGradient(0, 0, 0, groundY);
    skyGrad.addColorStop(0, "#4a148c"); skyGrad.addColorStop(1, "#ff7043");
    ctx.fillStyle = skyGrad; ctx.fillRect(0, 0, W, H);

    // 2. INFINITE HEART CLOUDS
    ctx.fillStyle = "rgba(255, 255, 255, 0.25)";
    for(let i = 0; i < 20; i++) {
        let heartX = ((i * 800 - cam.x * 0.1) % (W + 800)) - 100;
        if (heartX < -100) heartX += (W + 800);
        drawHeart(heartX, 50 + (i * 30) % 200, 20);
    }

    // 3. OCEAN
    const oceanGrad = ctx.createLinearGradient(0, groundY - 45, 0, groundY);
    oceanGrad.addColorStop(0, "#4fc3f7"); oceanGrad.addColorStop(1, "#0288d1");
    ctx.fillStyle = oceanGrad; ctx.fillRect(0, groundY - 45, W, 45);
    // REFINED SUBTLE WATER GLOW
    ctx.fillStyle = "rgba(255, 255, 255, 0.12)"; // Lowered from 0.2 to 0.12
    for (let i = 0; i < 6; i++) {
        // Slower drift (0.0006) and less horizontal movement
        let driftX = (Math.sin(Date.now() * 0.0006 + i) * 30) + (i * 180 - cam.x * 0.05) % W;
        if (driftX < 0) driftX += W;
        
        // Keep highlights closer to the horizon line
        let driftY = groundY - 38 + (i % 2) * 8;
        
        ctx.beginPath();
        // Thinner, longer ellipses for a flatter water look
        ctx.ellipse(driftX, driftY, 45, 1.5, 0, 0, Math.PI * 2);
        ctx.fill();
    }

    // 4. SAND
    const sandGrad = ctx.createLinearGradient(0, groundY, 0, H);
    sandGrad.addColorStop(0, "#ffe082"); sandGrad.addColorStop(1, "#c7a54b");
    ctx.fillStyle = sandGrad; ctx.fillRect(0, groundY, W, H - groundY);

    // Inside draw()
    // 4.5 FINISH LINE (Appears when you're within 1500m)
    if (finishX - player.x < 1500) {
      drawHeartArch(finishX);
    }

    // 5. CHECKPOINTS
    checkpointState.forEach(cp => drawPalmTree(cp.x - cam.x, groundY, cp.hit));

   // 6. STYLIZED GLASSY OBSTACLES
    obstacles.forEach(ob => {
      const ox = ob.x - cam.x;
      // Shadow
      ctx.fillStyle = "rgba(0,0,0,0.15)";
      ctx.fillRect(ox + 4, ob.y + 4, ob.w, ob.h);

      // Main Pink Body with Gradient
      const obGrad = ctx.createLinearGradient(ox, ob.y, ox + ob.w, ob.y + ob.h);
      obGrad.addColorStop(0, "#ff4f86");
      obGrad.addColorStop(1, "#d81b60");
      ctx.fillStyle = obGrad;
      ctx.fillRect(ox, ob.y, ob.w, ob.h);
      
      // Top Highlight & Gloss Streak
      ctx.fillStyle = "rgba(255,255,255,0.4)";
      ctx.fillRect(ox, ob.y, ob.w, 4);
      ctx.fillStyle = "rgba(255,255,255,0.1)";
      ctx.fillRect(ox + (ob.w * 0.2), ob.y, ob.w * 0.1, ob.h);
    });

    

    // 7. PLAYER
    drawCoconutPlayer(player.x - cam.x, player.y, player.r, player.rotation, player.alive);

  // 8. REFINED HEART PARTICLES
    fireworks.forEach(h => {
      ctx.save();
      // A more reddish-pink (DeepPink/Crimson hue)
      ctx.fillStyle = `rgba(255, 20, 100, ${h.life / 50})`; 
      drawHeart(h.x - cam.x, h.y, h.size);
      ctx.restore();
    });

    if (isTerminated) {
    // 1. Keep spawning fireworks for the finale
    if (Math.random() < 0.3) {
        spawnHeart(cam.x + Math.random() * W, H); // Rain hearts from the bottom
    }

    // 2. Increase the fade-out speed
    finalFade += 0.005; 
    
    // 3. Draw the black overlay
    ctx.fillStyle = `rgba(15, 15, 20, ${finalFade})`;
    ctx.fillRect(0, 0, W, H);

    // 4. Draw the final text when it's dark enough
    if (finalFade > 0.7) {
        ctx.fillStyle = `rgba(255, 122, 162, ${finalFade})`;
        ctx.font = "bold 40px system-ui";
        ctx.textAlign = "center";
        ctx.fillText("Kyel x Eruab <3", W/2, H/2);
    }
}

    requestAnimationFrame(draw);
  }

  

  document.getElementById("modalBtn").addEventListener("click", () => {
    // 1. If the quiz isn't done yet, show the first question and stop here
    if (!quizCompleted) {
        showQuestion();
        return;
    }

    if (document.getElementById("modalBtn").textContent === "The End ‚ù§Ô∏è") {
        terminateGame();
        return; 
    }

    // 2. If quiz IS done, handle the music
    const music = document.getElementById("bgMusic");
    music.volume = 0.1;
    if (music.paused) music.play().catch(e => console.log("Audio blocked"));
    
    // 3. Hide the modal and start the game
    document.getElementById("modal").style.display = "none";
    
    if (!player.alive || player.x >= finishX) {
        // Reset for a new run
        document.getElementById("infoSection").style.display = "grid"; 
        init();
    }
    
    paused = false; 
    gameStarted = true;
});

  // KEYBOARD JUMP
  window.addEventListener("keydown", (e) => {
    if ((e.code === "Space" || e.code === "ArrowUp") && player.onGround && !paused) {
      player.vy = -16; 
      player.onGround = false;
    }
  });

  // MOBILE TOUCH JUMP
  window.addEventListener("touchstart", (e) => {
    // If the game is running and not paused, jump!
    if (player.onGround && !paused && gameStarted) {
      player.vy = -16; 
      player.onGround = false;
      
      // This prevents the screen from bouncing/scrolling while playing
      if (e.target.id !== "modalBtn") { 
          e.preventDefault(); 
      }
    }
  }, { passive: false });

  init();
  setInterval(update, 1000/60);
  draw();
})();
</script>
<audio id="bgMusic" loop>
  <source src="https://files.catbox.moe/hq4kc4.mp3" type="audio/mpeg">
</audio>
</body>
</html>
